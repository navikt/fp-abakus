name: Bygg og deploy

on:
  push:
    branches:
      - '**'
    paths-ignore:
      - '**.md'
      - '**.MD'
      - '.gitignore'
      - 'LICENSE'
      - 'CODEOWNERS'
      - 'dokumentasjon/**'
      - 'lokalutvikling/**'
  schedule:
    - cron: '0 4 * * 1'

jobs:
    build-app:
      name: Build
      uses: navikt/fp-gha-workflows/.github/workflows/build-app.yml@main
      with:
        use-oracle: false # default: true
        sonar-scan: true # default: false
        push: ${{ github.ref_name == 'master' }} # default: false
      secrets: inherit

    create-issue:
      name: Issues
      if: github.ref_name == 'master'
      needs: build-app
      uses: navikt/fp-gha-workflows/.github/workflows/issues.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
      secrets: inherit

    promote-dev:
      name: Deploy
      if: github.ref_name == 'master'
      needs: [ build-app, create-issue ]
      uses: navikt/fp-gha-workflows/.github/workflows/promote.yml@main
      with:
        issue-number: ${{ needs.create-issue.outputs.issue-number }}
        cluster: 'dev-fss'
        resource: 'dev-fss-teamforeldrepenger.yaml' # default: naiserator.yaml
      secrets: inherit

    trigger-autotest-fp:
      name: Autotest FP
      if: github.ref_name == 'master'
      needs: [ build-app, create-issue ]
      uses: navikt/fp-gha-workflows/.github/workflows/autotest.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
        issue-number: ${{ needs.create-issue.outputs.issue-number }}
      secrets: inherit

    trigger-autotest-k9:
      name: Autotest K9
      if: github.ref_name == 'master'
      needs: [ build-app, create-issue ]
      uses: navikt/fp-gha-workflows/.github/workflows/autotest.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
        issue-number: ${{ needs.create-issue.outputs.issue-number }}
        test-repo: 'k9-verdikjede' # default: fpsak-autotest
        test-workflow: 'build.yml' # default: trigger.yml
      secrets: inherit

    snyk:
      name: Snyk
      needs: build-app
      uses: navikt/fp-gha-workflows/.github/workflows/snyk.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
      secrets: inherit

