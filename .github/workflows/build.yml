name: Bygg og deploy

on:
  push:
    branches:
      - '**'
    paths-ignore:
      - '**.md'
      - '**.MD'
      - '.gitignore'
      - 'LICENSE'
      - 'CODEOWNERS'
      - 'dokumentasjon/**'
      - 'lokalutvikling/**'
  schedule:
    - cron: '0 4 * * 1'

jobs:
    build-app:
      services:
        postgres:
          image: postgres:12
          env:
            POSTGRES_USER: fpabakus_unit
            POSTGRES_PASSWORD: fpabakus_unit
            POSTGRES_DB: fpabakus_unit
          ports:
            - 5432:5432
          # needed because the postgres container does not provide a healthcheck
          options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

      steps:
      - name: Build
        uses: navikt/fp-gha-workflows/.github/workflows/build-app.yml@main
        with:
          use-oracle: false # default: true
          db-host: localhost # default: localhost
          db-port: job.services.postgres.ports[5432]
          sonar-scan: true # default: false
          push: ${{ github.ref_name == 'master' }} # default: false
        secrets: inherit

    create-issue:
      name: Issues
      if: github.ref_name == 'master'
      needs: build-app
      uses: navikt/fp-gha-workflows/.github/workflows/issues.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
      secrets: inherit

      promote-dev:
        name: Deploy
        if: github.ref_name == 'master'
        needs: [ build-app, create-issue ]
        uses: navikt/fp-gha-workflows/.github/workflows/promote.yml@main
        with:
          issue-number: ${{ needs.create-issue.outputs.issue-number }}
          cluster: 'dev-fss'
          namespace: 'teamforeldrepenger' # default: 'teamforeldrepenger'
        secrets: inherit

    trigger-autotest-fp:
      name: Autotest FP
      if: github.ref_name == 'master'
      needs: [ build-app, create-issue ]
      uses: navikt/fp-gha-workflows/.github/workflows/autotest.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
        issue-number: ${{ needs.create-issue.outputs.issue-number }}
        test-repo: 'fpsak-autotest' # default: fpsak-autotest
        test-workflow: 'trigger.yml' # default: trigger.yml
      secrets: inherit

      trigger-autotest-k9:
        name: Autotest K9
        if: github.ref_name == 'master'
        needs: [ build-app, create-issue ]
        uses: navikt/fp-gha-workflows/.github/workflows/autotest.yml@main
        with:
          build-version: ${{ needs.build-app.outputs.build-version }}
          issue-number: ${{ needs.create-issue.outputs.issue-number }}
          test-repo: 'k9-verdikjede' # default: fpsak-autotest
          test-workflow: 'build.yml' # default: trigger.yml
        secrets: inherit

    snyk:
      name: Snyk
      needs: build-app
      uses: navikt/fp-gha-workflows/.github/workflows/snyk.yml@main
      with:
        build-version: ${{ needs.build-app.outputs.build-version }}
        java-version: '17' # default: 17
      secrets: inherit

